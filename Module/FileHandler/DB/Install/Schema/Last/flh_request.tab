-- table: flh_request
-- Запросы к модулю FileHandler
--
create table flh_request(
  request_id				integer not null,
  operation_code				varchar2( 10 ) not null,
  request_state_code			varchar2( 10 ) default 'WAIT' not null,
  command_text				varchar2( 1000 ),
  command_result				integer,
  file_full_path				varchar2( 1000 ),
  file_mask					varchar2( 100 ),
  max_list_count				integer,
  file_dest_path				varchar2( 1000 ),
  is_ovewrite				integer,
  write_mode				integer,
  encoding					varchar2( 50 ),
  is_gzipped				number( 1, 0 ),
  file_data_id				integer,
  used_cached_directory_id		integer,
  is_cache_used				integer,
  error_code				integer,
  error_message				varchar2( 512 ),
  last_processed				timestamp with time zone,
  source_id					integer,
  source_table_name			varchar2( 30 ),
  batch_short_name			varchar2( 50 ),
  priority_order				number,
  handler_sid 				integer,
  handler_serial#				integer,
  is_handler_used				number( 1, 0 ),
  request_time				timestamp with time zone
  						  default systimestamp not null,
  handler_reserved_time			timestamp with time zone,
  date_ins					date default sysdate not null,
  constraint flh_request_pk primary key( request_id )
    using index tablespace &indexTablespace,
  constraint flh_request_uk unique( request_id, request_state_code )
    using index tablespace &indexTablespace,
  constraint flh_request_ck_state_code check (
    request_state_code in
    ( 'WAIT', 'PROCESSED', 'ERROR' )
  )
  ,  constraint flh_request_ck_handler check(
    (
      is_handler_used is null
      and request_state_code = 'WAIT'
      or
      is_handler_used in ( 0, 1 )
	and request_state_code in ( 'PROCESSED', 'ERROR' )
    )
    and
    (
    handler_sid is null
    and handler_serial# is null
    and handler_reserved_time is null
    or
    handler_sid is not null
    and handler_serial# is not null
    )
  )
  ,
  constraint flh_request_ck_operation check (
    operation_code = 'COMMAND'
    and
    ( request_state_code in ('WAIT','ERROR')
      or request_state_code = 'PROCESSED'
      and command_result is not null
      and file_data_id is not null
    )
    and command_text is not null
    and file_full_path is null
    and file_dest_path is null
    and used_cached_directory_id is null
    or
    operation_code in ( 'LIST', 'DIRLIST' )
    and command_text is null
    and file_full_path is not null
    and file_dest_path is null
    or
    operation_code in ('LOADTEXT','LOADBINARY')
    and command_text is null
    and file_full_path is not null
    and file_dest_path is null
    or
    operation_code = 'UNLOADTEXT'
    and command_text is null
    and file_data_id is not null
    and file_full_path is not null
    and file_dest_path is null
    or
    operation_code = 'COPY'
    and command_text is null
    and file_data_id is null
    and file_full_path is not null
    and file_dest_path is not null
    or
    operation_code = 'MOVE'
    and command_text is null
    and file_data_id is null
    and file_full_path is not null
    and file_dest_path is not null
    or
    operation_code = 'DELETE'
    and command_text is null
    and file_data_id is null
    and file_full_path is not null
    and file_dest_path is null
  ),
  constraint flh_request_ck_processed check (
    request_state_code = 'WAIT'
    and last_processed is null
    or request_state_code in ( 'PROCESSED', 'ERROR' )
    and last_processed is not null
  ),
  constraint flh_request_ck_error check (
    error_code is not null
    and error_message is not null
    and request_state_code in ( 'ERROR', 'WAIT' )
    or
    error_code is null
    and error_message is null
    and request_state_code in ( 'WAIT', 'PROCESSED' )
  ),
  constraint flh_request_ck_source check(
    source_table_name = lower( source_table_name )
  )
)
/
comment on table flh_request is
'Запросы к модулю FileHandler
[ SVN root: Oracle/Module/FileHandler]
'
/
comment on column flh_request.request_id is
'Id записи. Первичный ключ таблицы'
/
comment on column flh_request.operation_code is
'Код операции запроса ( ссылка на flh_request_operation)'
/
comment on column flh_request.request_state_code is
'Состояние запроса ( ссылка на flh_request_state)'
/
comment on column flh_request.command_text is
'Текст команды OS для соотв. операций'
/
comment on column flh_request.command_result is
'Возвращаемый результат выполнения команды OS'
/
comment on column flh_request.file_full_path is
'Полный путь к файлу ( директории ) - источнику'
/
comment on column flh_request.file_mask is
'Маска для имён файлов'
/
comment on column flh_request.max_list_count is
'Максимальное количество файлов в списке'
/
comment on column flh_request.file_dest_path is
'Полный путь к файлу ( директории ) - назначению'
/
comment on column flh_request.is_ovewrite is
'Перезаписывать ли файл ( 1-да, 0 -нет)'
/
comment on column flh_request.write_mode is
'Способ выгрузки файла ( см. <FileHandler.UnloadTxt>)'
/
comment on column flh_request.file_data_id is
'Id данных файла'
/
comment on column flh_request.encoding is
'Кодировка символов'
/
comment on column flh_request.is_gzipped is
'Флаг сжатия с помощью GZIP'
/
comment on column flh_request.used_cached_directory_id is
'Id использованной кэшированной директории'
/
comment on column flh_request.is_cache_used is
'Использован ли cache ( данные кэшированной директории )
для обработки запроса'
/
comment on column flh_request.error_code is
'Код ошибки обработки'
/
comment on column flh_request.error_message is
'Сообщение об ошибке обработки'
/
comment on column flh_request.last_processed is
'Дата последней обработки или попытки обраотки запроса'
/
comment on column flh_request.source_id is
'Id исходной записи. Информационное поле'
/
comment on column flh_request.source_table_name is
'Имя исходной таблицы. Информационное поле'
/
comment on column flh_request.batch_short_name is
'Имя батча, сеанс job'а которого добавил запрос'
/
comment on column flh_request.priority_order is
'Приоритет запроса. Вначале обрабатываются запросы с большим приоритетом'
/
comment on column flh_request.handler_sid is
'Атрибут сеанса обработчика: "sid"'
/
comment on column flh_request.handler_serial# is
'Атрибут сеанса обработчика: "serial#"'
/
comment on column flh_request.is_handler_used is
'Использован ли real-time обработчик для обработки запроса или
использованы данные cache до передачи запроса обработчикам'
/
comment on column flh_request.request_time is
'Время создания запроса ( уточнение date_ins)'
/
comment on column flh_request.handler_reserved_time is
'Время резервирования запроса для обработки'
/
comment on column flh_request.date_ins is
'Дата добавления записи'
/
-- index: flh_request_ix_cached
-- Индекс для доступа по вторичному ключу
create index flh_request_ix_cached on flh_request(
  used_cached_directory_id
)
tablespace &indexTablespace
/
-- index: flh_request_ix_file_data
-- Индекс для доступа по вторичному ключу
create index flh_request_ix_file_data on flh_request(
  file_data_id
)
tablespace &indexTablespace
/
create index flh_request_ix_wait on flh_request
(
  case request_state_code when 'WAIT' then
    request_id
  end
  ,
  case request_state_code when 'WAIT' then
    handler_sid
  end
  ,
  case request_state_code when 'WAIT' then
    handler_serial#
  end
  ,
  case request_state_code when 'WAIT' then
    priority_order
  end
  ,
  case request_state_code when 'WAIT' then
    operation_code
  end
  ,
  case request_state_code when 'WAIT' then
    batch_short_name
  end
  ,
  case request_state_code when 'WAIT' then
    used_cached_directory_id
  end
)
tablespace &indexTablespace
/
-- index:  flh_request_ix_date_ins
-- Индекс для доступа по дате создания записи
-- запроса
create index flh_request_ix_date_ins on flh_request(
  date_ins
)
tablespace &indexTablespace
/
-- index: flh_request_ix_batch
-- Индесирование внешнего ключа
create index flh_request_ix_batch on flh_request(
  existing_batch_short_name
)
tablespace &indexTablespace
/
-- sequence: flh_request_seq
-- Последователность для генерации первичного ключа
create sequence  flh_request_seq
/
