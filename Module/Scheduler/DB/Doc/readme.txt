title: Описание

Модуль предназначен для выполнения пакетных заданий в БД Oracle по расписанию.


group: Концепции

*Job*, или задание, представляет собой именованный PL-SQL блок, который может
использовать параметры батчей ( пакетных заданий, см. ниже), а также некоторые
предопределённые переменные:

   - batchShortName           - короткое наименование батча ( входное значение)
   - jobResultId              - результат выполнения job ( выходное значение,
                                следует использовать константы
                                <pkg_Scheduler::Id результата выполнения>,
                                по-умолчанию
                                <pkg_Scheduler.True_ResultId>)
   - jobResultMessage         - сообщение результата выполнения job
                                ( выходное значение, по-умолчанию принимает
                                  значение в зависимости от jobResultId)
   - restartBatchFlag         - следует ли повторно немедленно выполнять батча
                                ( выходное значение, по-умолчанию 0)
   - retryBatchFlag           - следует ли повторно выполнять батч ( выходное
                                значение, по-умолчанию 0)

Job'ы могут иметь три
*уровня видимости*:

  - *публичный* - данный job доступен всем модулям ( может быть использован
    батчей любого модуля); при этом короткое наименование job (
    job_short_name) уникально в пределах модуля; Этот уровень видимости
    соответствует флагу public_flag = 1 в таблице <sch_job>;
  - *уровень видимости "модуля"* - job доступен всем батчам модуля; короткое наименование job
    уникально в пределах модуля; public_flag = 0, batch_short_name = null в
    таблице <sch_job>;
  - *уровень видимости "батча"* - job может быть использован только в одном батче;
    короткое наименование job уникально в пределах батча; public_flag = 0,
    batch_short_name равно короткому наименованию батча;

*Батч*, или пакетное задание, представляет собой упорядоченное множество *элементов*,
соответствующих job, связанных *условиями выполнения*, имеющее *расписание
запуска* и *параметры* ( опции батча). При *выполнении* элементы ( job,
соответствующие элементам) запускаются по-порядку, если удовлетворены условия
запуска job, которые представляют собой пары ( номер элемента в батче,
результат выполнения). Для каждого из элементов, номера которых участвуют в
условии, проверяется вхождение его результата выполнения во множество заданных
в условии результатов. При этом элемент ( job), на который ссылается условие,
должен быть выполнен к моменту проверки условия.

*Загрузка батчей в БД* реализована в OraMakeSystem с помощью вызовов
процедур модуля Scheduler ( пакет <pkg_SchedulerLoad>), данные для параметров
которых берутся из данных локальных файлов модуля ( *.job.sql, batch.xml,
batch_config.xml); Настрока для файлов данных батчей происходит аналогично
настройке sql-скриптов ( настраивается цель <installBatchTarget>), в частности
можно использовать <FILE_MASK>, <SKIP_FILE_MASK>; Подробнее о загрузке см. автодокументацию
к OraMakeSystem, раздел "Описание", подраздел "Загрузка батчей модуля Scheduler в БД".



group: Реализация батча


*Последовательность шагов* по реализации батча:

- *создание директории батча*

  Это директория "Install\Batch\Last\<Короткое наименование батча>"
  в простейшем случае, когда батч должен проливаться в основную схему модуля (
  соответствующую LOAD_USERID). В случае когда схема или БД отличаются основных
  схемы и БД модуля следует настроить переменную Makefile installBatchTarget.
  Батч рекомендуется располагать при этом в директории
  "Install\Batch\Last\Local\<Имя БД>\<Короткое наименование батча>"
  либо "Install\Batch\Last\<Условное ( логическое) имя БД>\<Короткое наименование батча>".
  Будем называть созданную директорию директорией батча.

- *создание job*

  Для каждого job предстоящих батчей следует решить, какого
  уровня доступа ( см. <Концепции>) он будет и в зависимости от этого
  располагать скрипты *.job.sql; Job уровня батча следует располагать в
  директории батча. Job'ы уровня модуля располагаются в "Install\Batch\Last"
  либо в "Install\Batch\Last\<Имя БД>" в случае если job относится не к
  основной схеме БД ( в этом случае нужно дополнительно настроить
  installBatchTarget).  OraMakeSystem определяет имеет уровень видимости job
  в завимисости от наличия файла batch.xml ( см. ниже).  Публичные ( или общие)
  job'ы должны располагаться в директории "Install\Batch\Last\PublicJob" ( либо
  соответствующей другой схеме).  OraMakeSystem определяет, что job публичный,
  в случае если родительская директория файла реализации называется PublicJob.
  См. также "Структура каталогов" в автодокументации к OraMakeSystem. Файл
  с именем <короткое наименование job>.job.sql представляет собой sql-файл,
  с комментариями на первых строках ( комментариями вида "-- "), которые
  интепретируются как имя job'а и описание job'а ( поле description). При этом
  наличие первой строки обязательно, все комментарии начиная со второй строки
  попадают в описание job и могут быть опущены. Имя файла без суффикса (
  расширения) .job.sql должно совпадать с коротким наименованием job (
  job_short_name, см. <Концепции>). Следует заметить, PL/SQL код job должен
  компилироваться по-умолчанию ( должен быть без ошибок, в частности, пакеты и процедуры
  должны существовать/быть доступны); Для того, чтобы игнорировать ошибки компиляции
  PL/SQL следует задать make-параметр <SKIP_CHECK_JOB>;

  Пример файла *.job.sql
  ( Oracle/Module/Mail/DB/Install/Batch/Last/ClearFetchMailRequest/process.job.sql)

(code)
-- Очистка данных обработанных запросов извлечения электронных писем
declare

  numDays number := pkg_Scheduler.getContextNumber(
    'NumDays'
  );

begin
  pkg_MailHandler.clearFetchRequest(
    beforeDate => sysdate - numDays
  );
end;
(end code)

- *формирование файла batch.xml*.

  Файл должен располагаться в директории батча.  В batch.xml могуть быть заданы
  настройки батча ( XML-элемент <batch_config>) или они могут быть заданы в
  отдельном файле batch_config.xml ( см. *формирование xml с настройками батча*).
  Задание настроек в отдельных файлах необходимо в случае, если настройки
  батча отличаются ( или могут отличаться) для разных БД при загрузке одного и
  того же батча в разные БД.

  Элементы и атрибуты файла batch.xml:
  batch/@short_name           - обязательный атрибут; короткое наименование
                                батча ( рекомендуется использовать
                                последовательность английских слов с заглавной
                                буквы, удобно когда наименования батчей
                                начинаются с названия модуля, рекомендуется
                                использовать не более 25 символов)
  batch/name                  - наименование батча на русском языке ( обязательный)
  batch/name_eng              - наименование батча на английксом языке ( необязательный)
  batch/content               - элементы, соответствующие job из содержания
                                батча; далее описаны обязательные атрибуты
                                данных элементов
  batch/content/@id           - номер ( идентификатор) элемента содержания для
                                ссылки в условиях выполнения; обязательный
                                атрибут; должен быть целым числов ( но указан в
                                кавычках, как все xml-атрибуты)
  batch/content/@job          - короткое наименование job ( совпадает с именем
                                файла job без расширения); обязательный
                                атрибут.  В случае если не указан атрибут
                                "module" при загрузке batch.xml сначала
                                выполняется попытка найти job с указанным
                                job_short_name среди job'ов батча; иначе job
                                ищется среди job'ов модуля
  batch/content/@module       - имя модуля для публичных job ( здесь также
                                можно указать путь, например,
                                "Oracle/Module/Scheduler"; или даже указать
                                номер начальной ревизии SVN, например
                                "Oracle/Module/Scheduler@999")
  batch/content/condition     - элементы условий выполнения job ( элемента
                                содержимого); далее перечислены атрибуты;
                                строковое содержимое соответствует результату
                                выполнения элемента, определяемого атрибутом
                                "id", и должно быть одним из следующих кодов:
                                "true", "false", "error", "skip", "retry";
                                данные строковые коды соответствуют константам
                                <pkg_Scheduler::Id результата выполнения>
  batch/content/condition/@id - условие выполнения: номер ( идентификатор)
                                элемента содержимого, соответствующий атрибуту
                                "id" элемента content.

- *формирование xml с настройками батча*

  Чаще всего ( когда батч загружается в одну продукционную БД в одну схему) настройки
  батча располагаются в batch.xml; Если необходимо иметь разные настройки батча
  в разных БД следует создать файл batch_config.xml с элементами
  "batch_config", указывая атрибут "short_name". Часть свойств батча, задаваемых
  через <batch_config> можно менять через интерфейс ( например, интервал повторного
  выполнения или расписание), поэтому по-умолчанию часть настроек не обновляется
  в БД после создания батча и настройки в <batch_config.xml>
  служат только для инициализации настроек новых батчей.  Батч считается новым,
  если он не был загружен либо загружен в течение последних 24 часов. Иначе,
  для обновления настроек для существующих ( не новых) батчей, следует указывать
  make-параметры загрузки <UPDATE_SCHEDULE> и <UPDATE_OPTION_VALUE>.

  Элементы и атрибуты элемента batch_config:

  retry_count                 - количество попыток повторного выполнения
                                ( в случае если был установлен флаг
                                retryBatchFlag);
                                целое число; необязательный элемент;
  retry_interval              - интервал повторного выполнения в минутах; может
                                быть дробным числом с разделителем десятичной
                                дроби в виде "."; необязательный элемент;
  nls_language                - переменная NLS_LANGUAGE для батча при активации;
                                ( по-умолчанию устанавливается "AMERICAN")
                                необязательный элемент;
  nls_territory               - переменная NLS_TERRITORY для батча при
                                активации ( по-умолчанию значение берётся из
                                сессии, в которой активирован батч)
  schedule                    - элементы расписания батча
  schedule/name               - наименование расписания батча ( на русском);
                                обязательный элемент для элемента расписания;
  schedule/name_eng           - наименование расписания на английском;
                                необязательный элемент;
  schedule/interval           - элементы интервалов расписания
  schedule/interval/@type     - тип временного интервала; обязательный
                                атрибут;одно из значений "mm", "dw", "dd",
                                "hh24", "mi"
  schedule/interval/value     - значение интервала ( для случая когда
                                интервал, строго говоря, временной отрезок,
                                состоит из одной точки); должен быть задан
                                либо элемент "value" либо элементы "min_value",
                                "max_value"
  schedule/interval/min_value - минимальное значение интервала ( включительно);
                                должен быть задан либо элемент "value" либо
                                элементы "min_value", "max_value"
  schedule/interval/max_value - максимальное значение интервала (
                                включительно); должен быть задан либо элемент
                                "value" либо элементы "min_value", "max_value"
  schedule/interval/step      - шаг интервала; может быть задан только вместе с
                                "min_value" и "max_value"; по-умолчанию 1
  option                      - элементы опций ( параметров) батча; если нет
                                вложенных элементов, то считается, что значение
                                опции будет задаваться без разделения на
                                тестовую и промышленную среду и без
                                использования списка значений
  option/@short_name          - короткое наименование опции батча; обязательный
                                атрибут; уникальное значение для каждой опции
  option/@type                - тип опции батча; обязательный атрибут; одно из
                                трёх значений "date", "number", "string"
  option/@name                - наименование опции ( на русском); обязательный
                                атрибут
  option/@encryption          - флаг хранения значений в зашифрованном виде;
                                1 да, 0 нет; по-умолчанию 0
  option/@access_level        - уровень доступа к опции через web-интерфейс;
                                "read" только для чтения, "value" для изменения
                                значений, "full" для полного доступа;
                                по-умолчанию "full"
  option/@description         - описание опции ( на русском); необязательный
                                атрибут
  option/value                - значение опции; данное значение устанавливается
                                и в тестовую и в продукционную среду; дата
                                записывается в формате "dd.mm.yyyy" либо
                                "dd.mm.yyyy hh24:mi:ss", дробные числа
                                записываются с десятичным разделителем ".";
  option/prod_value           - значение опции для продукционной среды;
                                может использоваться одновременно с элементом
                                "test_value", не может использоваться
                                одновременно с элементом "value";
                                Примечание ( вместо "prod_value" можно
                                использовать "production_value").
  option/test_value           - значение опции для тестовой среды;
                                может использоваться одновременно с элементом
                                "prod_value", не может использоваться
                                одновременно с элементом "value"
  option/value_list           - список значений опции, отдельные значения
                                указываются во вложенном элементе "item";
                                не может использоваться одновременно с
                                элементами "prod_value" или "test_value"
  option/prod_value_list      - список значений опции для продукционной среды,
                                отдельные значения указываются во вложенном
                                элементе "item"; может использоваться
                                одновременно с элементом "test_value_list", не
                                может использоваться одновременно с элементами
                                "prod_value", "test_value" или "value_list";
                                Примечание ( вместо "prod_value_list" можно
                                использовать "production_value_list").
  option/test_value_list      - список значений опции для тестовой среды,
                                отдельные значения указываются во вложенном
                                элементе "item"; может использоваться
                                одновременно с элементом "prod_value_list", не
                                может использоваться одновременно с элементами
                                "[prod_|test_]value" или "value_list";
  option/*value_list/@separator - символ, который будет использоваться в
                                качестве разделителя отдельных значений
                                при сохранении списка значений в виде строки,
                                указанный символ не должен использоваться
                                в самих значениях; по умолчанию символ ";";
                                применяется как атрибут для элементов
                                "value_list", "prod_value_list",
                                "test_value_list"
  option/*value_list/item     - отдельное значение из списка значений опции;
                                дата записывается в формате "dd.mm.yyyy" либо
                                "dd.mm.yyyy hh24:mi:ss", дробные числа
                                записываются с десятичным разделителем ".";
                                применяется как вложенный элемент для элементов
                                "value_list", "prod_value_list",
                                "test_value_list"
  option/*value*/@instance    - имя экземпляра БД ( без учета регистра), в
                                которой может использоваться значение; по
                                умолчанию без ограничений; применяется как
                                атрибут для элементов "value", "prod_value",
                                "test_value", "value_list", "prod_value_list",
                                "test_value_list", при этом можно указать
                                несколько одинаковых элементов для одной опции,
                                но значение атрибута "instance" для каждого из
                                них должно различаться ( в т.ч. не более чем
                                один элемент может быть задан без указания либо
                                с пустым значением атрибута "instance");


  Пример файла batch.xml
  ( Oracle/Module/Mail/DB/Install/Batch/Last/ClearFetchMailRequest/batch.xml):

(code)
<?xml version="1.0" encoding="Windows-1251"?>
<batch short_name="ClearFetchMailRequest">
  <name>Очистка данных обработанных запросов извлечения электронных писем</name>
  <batch_config>
    <retry_count>2</retry_count>
    <retry_interval>60</retry_interval>
    <schedule>
      <name>every night at 00:15</name>
      <interval type="hh24">
        <value>0</value>
      </interval>
      <interval type="mi">
        <value>15</value>
      </interval>
    </schedule>
    <option short_name="NumDays" type="number" name="Количество дней от текущей даты">
      <value>60</value>
    </option>
  </batch_config>
  <content id="1" job="initialization" module="Scheduler"/>
  <content id="2" job="process">
    <condition id="1">true</condition>
  </content>
  <content id="3" job="commit" module="Scheduler">
    <condition id="2">true</condition>
  </content>
  <content id="4" job="retry_batch" module="Scheduler">
    <condition id="3">skip</condition>
    <condition id="3">error</condition>
  </content>
</batch>
(end code)
